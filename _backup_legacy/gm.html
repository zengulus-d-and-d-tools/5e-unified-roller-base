<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GM Dashboard v1.5</title>
    <style>
        :root {
            --bg: #0f0f13;
            --card-bg: rgba(30, 30, 35, 0.6);
            --input-bg: rgba(0, 0, 0, 0.3);
            --accent: #00bcd4;
            --accent-glow: rgba(0, 188, 212, 0.4);
            --text: #f0f0f0;
            --border: rgba(255, 255, 255, 0.1);
            --green: #00e676;
            --red: #ff5252;
            --cyan: #18ffff;
            --pink: #ff4081;
            --glass: blur(12px);
        }

        canvas#vector-cloud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 var(--accent-glow);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 0, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
            }
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f13 0%, #1a1a20 100%);
            color: var(--text);
            padding: 0;
            margin: 0;
            padding-bottom: 90px;
            padding-top: 60px;
            min-height: 100vh;
        }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 55px;
            background: rgba(15, 15, 19, 0.85);
            border-bottom: 1px solid var(--border);
            display: flex;
            z-index: 1000;
            backdrop-filter: var(--glass);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .nav-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: #888;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.5px;
        }

        .nav-item.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: linear-gradient(to top, rgba(0, 188, 212, 0.1), transparent);
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            display: none;
            position: relative;
            z-index: 1;
            animation: fadeIn 0.4s ease-out;
        }

        .container.active {
            display: block;
        }

        /* --- UI ELEMENTS --- */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .section-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #aaa;
            font-weight: 700;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: 0.2s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
            background: rgba(0, 0, 0, 0.5);
        }

        /* Custom Checkbox */
        input[type="checkbox"] {
            width: 22px;
            height: 22px;
            appearance: none;
            -webkit-appearance: none;
            border: 2px solid #555;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: grid;
            place-content: center;
            transition: 0.2s;
        }

        input[type="checkbox"]:checked {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            color: #000;
            font-weight: 900;
            font-size: 1rem;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            height: 44px;
            /* Touch target */
            font-size: 0.95rem;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        button:active {
            transform: scale(0.96);
        }

        .btn-main {
            background: var(--accent);
            color: #000;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .btn-main:hover {
            box-shadow: 0 6px 20px var(--accent-glow);
            filter: brightness(1.1);
        }

        .btn-sec {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
            border: 1px solid var(--border);
        }

        .btn-sec:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            border-color: #666;
        }

        .btn-danger {
            background: rgba(255, 82, 82, 0.2);
            color: var(--red);
            border: 1px solid rgba(255, 82, 82, 0.3);
        }

        .btn-danger:hover {
            background: rgba(255, 82, 82, 0.4);
            text-shadow: 0 0 8px var(--red);
        }

        .btn-success {
            background: rgba(0, 230, 118, 0.2);
            color: var(--green);
            border: 1px solid rgba(0, 230, 118, 0.3);
        }

        .btn-success:hover {
            background: rgba(0, 230, 118, 0.4);
            text-shadow: 0 0 8px var(--green);
        }

        .btn-sm {
            height: 36px;
            font-size: 0.8rem;
            padding: 0 14px;
        }

        /* --- ROLLER --- */
        .toggle-box {
            display: flex;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            border-radius: 10px;
            gap: 4px;
            border: 1px solid var(--border);
        }

        .toggle-btn {
            flex: 1;
            background: transparent;
            color: #666;
            height: 36px;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .toggle-btn.active {
            background: #333;
            color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .toggle-btn.active[data-mode="adv"] {
            background: var(--green);
            color: #000;
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.4);
        }

        .toggle-btn.active[data-mode="dis"] {
            background: var(--red);
            color: #fff;
            box-shadow: 0 0 10px rgba(255, 82, 82, 0.4);
        }

        .toggle-btn.active[data-luck="good"] {
            background: var(--cyan);
            color: #000;
            box-shadow: 0 0 10px rgba(24, 255, 255, 0.4);
        }

        .toggle-btn.active[data-luck="bad"] {
            background: var(--pink);
            color: #000;
            box-shadow: 0 0 10px rgba(255, 64, 129, 0.4);
        }

        .btn-tier {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
            color: #ddd;
            border: 1px solid var(--border);
            height: 48px;
        }

        .btn-tier:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
            padding-left: 20px;
        }

        .tier-bonus {
            font-family: 'Consolas', monospace;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 4px;
            color: var(--accent);
            font-weight: bold;
            border: 1px solid var(--border);
        }

        .log-display {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: right;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .log-result {
            color: var(--accent);
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 0 15px var(--accent-glow);
        }

        /* --- COMBAT LIST --- */
        .combat-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 60px;
        }

        .combat-item {
            display: grid;
            grid-template-columns: 45px 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid #333;
            background: var(--card-bg);
            border-radius: 8px;
            position: relative;
        }

        .combat-item.active {
            border: 2px solid var(--accent);
            background: #2a221a;
            box-shadow: 0 0 15px rgba(230, 126, 34, 0.1);
        }

        .init-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .init-val {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--accent);
            line-height: 1;
        }

        .init-tie {
            font-size: 0.65rem;
            color: #666;
            font-family: monospace;
        }

        .name-box {
            display: flex;
            flex-direction: column;
        }

        .name-main {
            font-weight: bold;
            font-size: 1rem;
            color: #fff;
        }

        .name-meta {
            font-size: 0.75rem;
            color: #888;
            margin-top: 2px;
        }

        .hp-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .hp-display {
            width: 45px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--red);
            background: #111;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #333;
        }

        .btn-dmg-qs {
            width: 32px;
            height: 32px;
            padding: 0;
            font-size: 0.9rem;
            font-weight: bold;
            background: #333;
            color: #ccc;
            border: 1px solid #444;
        }

        .btn-del {
            background: transparent;
            color: #666;
            font-size: 1.2rem;
            width: 30px;
            display: flex;
            justify-content: center;
            border-left: 1px solid #333;
            padding-left: 8px;
            margin-left: 4px;
        }

        /* --- FOOTER --- */
        .tracker-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(34, 34, 34, 0.95);
            padding: 10px;
            border-top: 1px solid #444;
            display: flex;
            gap: 10px;
            justify-content: space-between;
            z-index: 900;
            backdrop-filter: blur(5px);
        }

        .round-counter {
            background: #000;
            color: var(--accent);
            padding: 0 15px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #444;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .round-val {
            font-size: 1.2rem;
            line-height: 1;
        }

        /* --- REFERENCE --- */
        .accordion-btn {
            width: 100%;
            text-align: left;
            background: #252525;
            padding: 10px;
            border-bottom: 1px solid #333;
            font-weight: bold;
            font-size: 0.9rem;
            color: #ccc;
        }

        .accordion-body {
            padding: 10px;
            background: #1a1a1a;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #aaa;
            display: none;
            border-bottom: 1px solid #333;
        }

        .accordion-body.show {
            display: block;
        }

        .cond-tag {
            display: inline-block;
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            color: var(--accent);
            font-weight: bold;
            font-size: 0.7rem;
        }

        .webhook-box {
            margin-top: 20px;
            border-top: 1px solid #444;
            padding-top: 10px;
        }
    </style>
</head>

<body>
    <canvas id="vector-cloud"></canvas>
    <div class="nav-bar">
        <div class="nav-item" onclick="window.location.href='tools.html'"
            style="flex:0 0 60px; font-size:0.8rem; border-right:1px solid #444;">&larr;</div>
        <div class="nav-item active" onclick="switchTab('tracker')">Tracker</div>
        <div class="nav-item" onclick="switchTab('roller')">Roller</div>
        <div class="nav-item" onclick="switchTab('ref')">Ref & Loot</div>
    </div>

    <div id="tab-tracker" class="container active">

        <div class="card" style="border-top: 2px solid var(--green);">
            <div class="section-header">Add Single Combatant</div>
            <div class="grid-2">
                <input type="text" id="addName" placeholder="Name">
                <input type="number" id="addInit" placeholder="Total Init" style="font-weight:bold;">
            </div>
            <div class="row">
                <input type="number" id="addDex" placeholder="Dex Score" style="width:80px;"
                    title="Dex Score (Tie Breaker)">
                <input type="number" id="addHP" placeholder="HP" style="width:80px;">
                <button class="btn-success" style="flex:1;" onclick="addSingle()">Add</button>
            </div>
            <div style="font-size:0.7rem; color:#666; text-align:center;">*Init is final roll. Dex is score (10-20) for
                tie-break.</div>
        </div>

        <div class="card" style="border-top: 2px solid var(--accent);">
            <div class="section-header"
                onclick="document.getElementById('mobBody').style.display = document.getElementById('mobBody').style.display=='none'?'flex':'none'"
                style="cursor:pointer;">
                <span>Mob Generator</span> <span>â–¼</span>
            </div>
            <div id="mobBody" style="display:none; flex-direction:column; gap:10px;">
                <div class="grid-2">
                    <input type="text" id="mobName" placeholder="Base Name (e.g. Goblin)">
                    <input type="number" id="mobCount" placeholder="Count" value="1">
                </div>
                <div class="row">
                    <input type="number" id="mobInitMod" placeholder="Init Mod (+2)">
                    <input type="number" id="mobDexScore" placeholder="Dex Score (14)">
                    <input type="number" id="mobHP" placeholder="HP (7)">
                </div>
                <button class="btn-main" onclick="genMobs()">Roll & Generate</button>
            </div>
        </div>

        <div style="text-align:center; margin-top:20px; padding-bottom:20px;">
            <button class="btn-danger btn-sm" onclick="clearCombat()">âš  Clear Encounter</button>
        </div>

        <div id="combatList" class="combat-list"></div>

        <div class="tracker-footer">
            <div class="round-counter">
                <span>Round</span>
                <span class="round-val" id="roundVal">1</span>
            </div>
            <button class="btn-sec" onclick="prevTurn()" style="width:50px;">â—€</button>
            <button class="btn-main" style="flex:1;" onclick="nextTurn()">Next Turn â–¶</button>
        </div>
    </div>

    <div id="tab-roller" class="container">
        <div class="log-display">
            <div class="log-label" id="rollLabel">Ready...</div>
            <div class="log-result" id="rollVal">-</div>
            <div class="log-detail" id="rollFormula"></div>
        </div>

        <div class="card">
            <div class="section-header">Setup</div>
            <div class="row">
                <input type="text" id="adhocName" placeholder="Name (e.g. NPC)">
                <input type="text" id="adhocReason" placeholder="Reason (e.g. Stealth)">
            </div>
            <div class="row" style="margin-top:5px;">
                <div style="flex:1; display:flex; align-items:center; gap:10px;">
                    <label style="font-size:0.8rem; color:#888; white-space:nowrap;">Level / CR:</label>
                    <input type="number" id="rollLevel" value="1" min="1" max="30" oninput="updateBonuses()"
                        style="width:50px; text-align:center; font-weight:bold;">
                    <div style="font-size:0.8rem; color:var(--accent);" id="pbDisplay">PB: +2</div>
                </div>
            </div>

            <div class="grid-2" style="margin-top:15px;">
                <div>
                    <div class="section-header">Roll Mode</div>
                    <div class="toggle-box">
                        <button class="toggle-btn" data-mode="dis" onclick="setMode('dis')">DIS</button>
                        <button class="toggle-btn active" data-mode="norm" onclick="setMode('norm')">â€”</button>
                        <button class="toggle-btn" data-mode="adv" onclick="setMode('adv')">ADV</button>
                    </div>
                </div>
                <div>
                    <div class="section-header">Luck Mod</div>
                    <div class="toggle-box">
                        <button class="toggle-btn" data-luck="bad" onclick="setLuck('bad')">Bad</button>
                        <button class="toggle-btn active" data-luck="norm" onclick="setLuck('norm')">â€”</button>
                        <button class="toggle-btn" data-luck="good" onclick="setLuck('good')">Good</button>
                    </div>
                </div>
            </div>

            <div class="section-header" style="margin-top:15px;">Quick Checks</div>
            <div class="tier-grid">
                <button class="btn-tier" onclick="rollTier('crap')">
                    <span>Crap <span style="font-size:0.7rem; color:#666;">(d20 - 1)</span></span>
                    <span class="tier-bonus" id="bonus-inc">-1</span>
                </button>
                <button class="btn-tier" onclick="rollTier('competent')">
                    <span>Competent <span style="font-size:0.7rem; color:#666;">(PB)</span></span>
                    <span class="tier-bonus" id="bonus-comp">+2</span>
                </button>
                <button class="btn-tier" onclick="rollTier('talented')">
                    <span>Talented <span style="font-size:0.7rem; color:#666;">(PB + 2)</span></span>
                    <span class="tier-bonus" id="bonus-tal">+4</span>
                </button>
                <button class="btn-tier" onclick="rollTier('expert')">
                    <span>Expert <span style="font-size:0.7rem; color:#666;">(2xPB + 2)</span></span>
                    <span class="tier-bonus" id="bonus-exp">+6</span>
                </button>
                <button class="btn-tier" onclick="rollTier('master')">
                    <span>Master <span style="font-size:0.7rem; color:#666;">(2xPB + 5)</span></span>
                    <span class="tier-bonus" id="bonus-mas">+9</span>
                </button>
            </div>

            <div class="section-header" style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">Arbitrary
                Roll</div>
            <div class="row">
                <input type="number" id="manualBonus" placeholder="Mod (+/-)" style="font-weight:bold;">
                <button class="btn-sec" style="width:100px;" onclick="rollManual()">Roll</button>
            </div>

            <div class="webhook-box">
                <div class="section-header">Discord Integration</div>
                <input type="text" id="webhookUrl" placeholder="Webhook URL..." oninput="saveGM()">
                <label style="display:flex; align-items:center; gap:8px; margin-top:10px; cursor:pointer;">
                    <input type="checkbox" id="discordActive" onchange="saveGM()">
                    <span style="color:#fff; font-weight:bold;">Active</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; margin-top:10px; cursor:pointer;">
                    <input type="checkbox" id="secretRoll">
                    <span style="color:var(--accent); font-weight:bold;">Secret Roll (||Spoiler||)</span>
                </label>
            </div>
        </div>

        <div class="card">
            <div class="section-header">DC Estimator</div>
            <input type="range" min="5" max="30" value="10" step="5" oninput="updateDC(this.value)">
            <div style="text-align:center;">
                <div style="font-size:2rem; font-weight:bold; color:var(--accent);" id="dcDisplay">DC 10</div>
                <div style="color:#888; font-size:0.9rem;" id="dcDesc">Medium</div>
            </div>
        </div>
    </div>

    <div id="tab-ref" class="container">
        <!-- BESTIARY CARD -->
        <div class="card">
            <div class="section-header">Bestiary / Presets</div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="mobSaveName" placeholder="Preset Name (e.g. Goblin)">
                <button class="btn-main" onclick="saveMobPreset()" style="width:80px;">Save</button>
            </div>
            <div style="font-size:0.7rem; color:#888; margin-top:5px;">Saves current Mob Generator settings.</div>

            <div id="bestiaryList" style="margin-top:15px; display:grid; gap:8px;"></div>
        </div>

        <div class="card">
            <div class="section-header">Data Management</div>
            <div class="grid-2">
                <button class="btn-sec" onclick="exportGM()">ðŸ’¾ Export JSON</button>
                <button class="btn-sec" onclick="importGM()">ðŸ“‚ Import JSON</button>
            </div>
        </div>

        <div class="card">
            <div class="section-header">Quick Loot</div>
            <div class="grid-2">
                <button class="btn-sec" onclick="genLoot('pocket')">Pocket Lint</button>
                <button class="btn-sec" onclick="genLoot('trinket')">Trinket</button>
            </div>
            <div id="lootResult"
                style="margin-top:10px; font-style:italic; color:var(--accent); min-height:20px; text-align:center; transition: opacity 0.2s ease-in-out;">
            </div>
        </div>

        <div class="card">
            <div class="section-header">Scratchpad</div>
            <textarea id="scratchpad" rows="6" placeholder="Notes..." oninput="saveGM()"></textarea>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <div class="section-header" style="margin:10px 10px 0 10px; border:none;">Conditions Ref</div>
            <div id="conditionsList"></div>
        </div>
    </div>

    <script>
        let gmData = {
            combatants: [],
            bestiary: [], // [{name, init, dex, hp, count}]
            round: 1,
            activeIdx: 0,
            webhook: '',
            discordActive: false,
            scratchpad: '',
            rollLevel: 1
        };

        // ... existing vars ...

        // --- BESTIARY LOGIC ---
        function saveMobPreset() {
            const name = document.getElementById('mobSaveName').value.trim();
            if (!name) return alert("Enter a name");

            const preset = {
                name: name,
                baseName: document.getElementById('mobName').value,
                count: document.getElementById('mobCount').value,
                initMod: document.getElementById('mobInitMod').value,
                dex: document.getElementById('mobDexScore').value,
                hp: document.getElementById('mobHP').value
            };

            gmData.bestiary.push(preset);
            document.getElementById('mobSaveName').value = '';
            saveGM(); renderBestiary();
        }

        function loadMobPreset(idx) {
            const p = gmData.bestiary[idx];
            document.getElementById('mobName').value = p.baseName || '';
            document.getElementById('mobCount').value = p.count || 1;
            document.getElementById('mobInitMod').value = p.initMod || '';
            document.getElementById('mobDexScore').value = p.dex || '';
            document.getElementById('mobHP').value = p.hp || '';
            alert("Loaded: " + p.name);
        }

        function delMobPreset(idx) {
            if (confirm("Delete preset?")) {
                gmData.bestiary.splice(idx, 1);
                saveGM(); renderBestiary();
            }
        }

        function renderBestiary() {
            const list = document.getElementById('bestiaryList');
            if (!list || !gmData.bestiary) return;

            if (gmData.bestiary.length === 0) { list.innerHTML = '<div style="color:#666; font-style:italic; padding:10px;">No presets saved.</div>'; return; }

            list.innerHTML = gmData.bestiary.map((b, i) => `
                <div style="display:flex; justify-content:space-between; align-items:center; background:#111; padding:8px; border-radius:6px; border:1px solid #333;">
                    <span style="font-weight:bold; color:#ddd;">${b.name}</span>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-sec btn-sm" onclick="loadMobPreset(${i})">Load</button>
                        <button class="btn-danger btn-sm" onclick="delMobPreset(${i})">&times;</button>
                    </div>
                </div>
            `).join('');
        }

        // --- CONDITION TAGS ---
        function addTag(idx) {
            const tag = prompt("Tag (e.g. Prone, Stunned):");
            if (tag) {
                if (!gmData.combatants[idx].tags) gmData.combatants[idx].tags = [];
                gmData.combatants[idx].tags.push(tag);
                saveGM(); renderCombat();
            }
        }

        function removeTag(cIdx, tIdx) {
            gmData.combatants[cIdx].tags.splice(tIdx, 1);
            saveGM(); renderCombat();
        }

        let rollMode = 'norm'; // norm, adv, dis
        let luckMode = 0; // -1, 0, 1

        // --- CONDITIONS & LOOT DATA ---
        const conditions = {
            "Blinded": "Auto-fail sight checks. Attacks against you have Adv. Your attacks have Disadv.",
            "Charmed": "Can't attack charmer. Charmer has Adv on social checks vs you.",
            "Deafened": "Auto-fail hearing checks.",
            "Frightened": "Disadv on checks/attacks while source is visible. Can't move closer.",
            "Grappled": "Speed 0. Ends if grappler incapacitated or moved away.",
            "Incapacitated": "No Actions or Reactions.",
            "Invisible": "Heavily Obscured. Attacks against you have Disadv. Your attacks have Adv.",
            "Paralyzed": "Incapacitated. Can't move/speak. Auto-fail Str/Dex saves. Attacks against have Adv. Critical hit if attacker is within 5ft.",
            "Petrified": "Weight x10. Incapacitated. Unaware. Resist all dmg. Immune Poison/Disease.",
            "Poisoned": "Disadv on Atk and Checks.",
            "Prone": "Crawl (half speed). Disadv on your Atks. Melee atks against you have Adv. Ranged atks against you have Disadv.",
            "Restrained": "Speed 0. Disadv on Dex saves. Attacks against you have Adv. Your attacks have Disadv.",
            "Stunned": "Incapacitated. Can't move. Auto-fail Str/Dex saves. Attacks against you have Adv.",
            "Unconscious": "Incapacitated. Drop items. Prone. Auto-fail Str/Dex saves. Attacks against have Adv. Crit if within 5ft."
        };

        const lootTables = {
            pocket: [
                { adjs: ["Rusty", "Bent", "Scratched", "Dull", "Twisted", "Tarnished"], nouns: ["Iron Nail", "Copper Coin (Fake)", "Tin Spoon", "Belt Buckle", "Skeleton Key", "Needle", "Brass Button"] },
                { adjs: ["Soggy", "Crumpled", "Torn", "Stained", "Moldy", "Greasy", "Faded"], nouns: ["Grocery List", "Handkerchief", "Playing Card", "Map Scrap", "Love Letter", "Ticket Stub", "Rag"] },
                { adjs: ["Rotten", "Dried", "Half-eaten", "Withered", "Stinky", "Petrified"], nouns: ["Apple Core", "Rat Tail", "Flower", "Root", "Crust of Bread", "Fish Bone", "Beetle Shell"] },
                { adjs: ["Tangled", "Knotted", "Frayed", "Short", "Braided", "Sticky"], nouns: ["Ball of String", "Length of Twine", "Copper Wire", "Shoelace", "Ribbon", "Wick", "Lock of Hair"] }
            ],
            trinket: {
                nouns: ["Ring", "Animal Figurine", "Bead", "Button", "Comb", "Whistle", "Locket", "Thimble", "Brooch", "Cameo", "Coin", "Pendant", "Earring", "Bangle"],
                suffixes: ["engraved with a name", "that feels warm", "missing a piece", "stained with ink", "smelling of sulfur", "wrapped in twine", "depicting a skull", "from a foreign land", "with a hidden compartment", "covered in runes"],
                cheap: { materials: ["Wooden", "Clay", "Pewter", "Bone", "Rusted Iron", "Chipped Ceramic", "Soapstone", "Leather", "Rough Copper", "Tin", "Carved Stone"], values: ["1 cp", "5 cp", "8 cp", "2 sp", "5 sp"] },
                fancy: { materials: ["Silver-inlaid", "Carved Ivory", "Polished Jade", "Gilded", "Crystal", "Obsidian", "Clockwork", "Alabaster", "Ancient Bronze", "Mahogany", "Electrum"], values: ["1 gp", "2 gp", "3 gp", "5 gp"] }
            }
        };

        // --- INITIALIZATION ---
        function init() {
            const saved = localStorage.getItem('gmDashboardData');
            if (saved) {
                gmData = JSON.parse(saved);
            }
            document.getElementById('webhookUrl').value = gmData.webhook || '';
            document.getElementById('discordActive').checked = gmData.discordActive || false;
            document.getElementById('scratchpad').value = gmData.scratchpad || '';
            document.getElementById('rollLevel').value = gmData.rollLevel || 1;

            updateBonuses();
            renderCombat();
            renderConditions();
            if (!gmData.bestiary) gmData.bestiary = [];
            renderBestiary();
        }

        function exportGM() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(gmData));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "gm_dashboard_" + new Date().toISOString().slice(0, 10) + ".json";
            document.body.appendChild(a); a.click(); a.remove();
        }

        function importGM() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const loaded = JSON.parse(event.target.result);
                        if (confirm("Overwrite data?")) {
                            gmData = loaded;
                            saveGM();
                            location.reload();
                        }
                    } catch (e) { alert("Error loading JSON"); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function saveGM() {
            gmData.webhook = document.getElementById('webhookUrl').value;
            gmData.discordActive = document.getElementById('discordActive').checked;
            gmData.scratchpad = document.getElementById('scratchpad').value;
            gmData.rollLevel = parseInt(document.getElementById('rollLevel').value) || 1;
            localStorage.setItem('gmDashboardData', JSON.stringify(gmData));
        }

        // --- ROLLER LOGIC ---
        function getPB(level) {
            return Math.ceil(1 + (level / 4));
        }

        function updateBonuses() {
            const lvl = parseInt(document.getElementById('rollLevel').value) || 1;
            const pb = getPB(lvl);

            document.getElementById('pbDisplay').innerText = `PB: +${pb}`;

            // Calculate with Luck included!
            const calc = (base) => {
                const val = base + luckMode;
                return (val >= 0 ? '+' : '') + val;
            };

            document.getElementById('bonus-inc').innerText = calc(-1);
            document.getElementById('bonus-comp').innerText = calc(pb);
            document.getElementById('bonus-tal').innerText = calc(pb + 2);
            document.getElementById('bonus-exp').innerText = calc((pb * 2) + 2);
            document.getElementById('bonus-mas').innerText = calc((pb * 2) + 5);

            saveGM();
        }

        function setMode(mode) {
            rollMode = mode;
            document.querySelectorAll('.toggle-btn[data-mode]').forEach(b => b.classList.remove('active'));
            document.querySelector(`.toggle-btn[data-mode="${mode}"]`).classList.add('active');
        }

        function setLuck(luckStr) {
            if (luckStr === 'bad') luckMode = -1;
            else if (luckStr === 'good') luckMode = 1;
            else luckMode = 0;

            document.querySelectorAll('.toggle-btn[data-luck]').forEach(b => b.classList.remove('active'));
            document.querySelector(`.toggle-btn[data-luck="${luckStr}"]`).classList.add('active');

            updateBonuses();
        }

        // SHARED ROLL FUNCTION
        function performRoll(bonus, reasonText) {
            const name = document.getElementById('adhocName').value || "GM";

            let rolls = [];
            let rawResult = 0;
            let formula = "";
            const r1 = Math.floor(Math.random() * 20) + 1;

            if (rollMode === 'norm') {
                rolls = [r1];
                rawResult = r1;
                formula = `[${r1}]`;
            } else {
                const r2 = Math.floor(Math.random() * 20) + 1;
                rolls = [r1, r2];
                if (rollMode === 'adv') {
                    rawResult = Math.max(r1, r2);
                    formula = `[${r1}, ${r2}] (ADV)`;
                } else {
                    rawResult = Math.min(r1, r2);
                    formula = `[${r1}, ${r2}] (DIS)`;
                }
            }

            const total = rawResult + bonus;
            if (bonus !== 0) formula += ` ${bonus >= 0 ? '+' : ''}${bonus}`;

            // UI Update
            document.getElementById('rollLabel').innerText = `${name} - ${reasonText}`;
            document.getElementById('rollVal').innerText = total;
            document.getElementById('rollFormula').innerText = formula;

            // Discord
            if (gmData.discordActive && gmData.webhook) {
                const isSecret = document.getElementById('secretRoll').checked;
                let content = `**${total}**\n${formula}`;
                if (isSecret) content = `||${content}||`;

                let color = 16777215; // White
                if (total >= 20) color = 3066993; // Green
                else if (total <= 5) color = 15158332; // Red

                sendDiscord(name, reasonText, content, isSecret ? 3447003 : color);
            }
        }

        function rollTier(tier) {
            const reasonInput = document.getElementById('adhocReason').value;
            const lvl = parseInt(document.getElementById('rollLevel').value) || 1;
            const pb = getPB(lvl);

            let baseBonus = 0;
            let tierLabel = "";

            switch (tier) {
                case 'crap': baseBonus = -1; tierLabel = "Crap"; break;
                case 'competent': baseBonus = pb; tierLabel = "Competent"; break;
                case 'talented': baseBonus = pb + 2; tierLabel = "Talented"; break;
                case 'expert': baseBonus = (pb * 2) + 2; tierLabel = "Expert"; break;
                case 'master': baseBonus = (pb * 2) + 5; tierLabel = "Master"; break;
            }

            // Apply Luck here mathematically
            const finalBonus = baseBonus + luckMode;

            // Clean Log Logic: Use input if available, else fallback to Tier Name
            const reason = reasonInput || tierLabel;

            performRoll(finalBonus, reason);
        }

        function rollManual() {
            const val = document.getElementById('manualBonus').value;
            const bonus = parseInt(val) || 0;
            const reasonInput = document.getElementById('adhocReason').value;
            const reason = reasonInput || "Manual Roll";

            performRoll(bonus, reason);
        }

        function sendDiscord(name, title, desc, color) {
            const payload = {
                embeds: [{
                    author: { name: name },
                    title: title,
                    description: desc,
                    color: color
                }]
            };
            fetch(gmData.webhook, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(console.error);
        }

        function updateDC(val) {
            const diffs = { 5: "Very Easy", 10: "Easy", 15: "Medium", 20: "Hard", 25: "Very Hard", 30: "Nearly Impossible" };
            document.getElementById('dcDisplay').innerText = "DC " + val;
            document.getElementById('dcDesc').innerText = diffs[val] || "Custom";
        }

        // --- COMBAT FUNCTIONS ---
        function sortCombat() {
            gmData.combatants.sort((a, b) => {
                if (b.total !== a.total) return b.total - a.total;
                return b.tie - a.tie;
            });
        }

        function addSingle() {
            const name = document.getElementById('addName').value || "Enemy";
            const initVal = parseFloat(document.getElementById('addInit').value) || 0;
            const dexScore = parseInt(document.getElementById('addDex').value) || 10;
            const hp = document.getElementById('addHP').value;

            gmData.combatants.push({
                id: Date.now(),
                name: name,
                total: initVal,
                tie: dexScore,
                hp: hp ? parseInt(hp) : null,
                maxHp: hp ? parseInt(hp) : null
            });

            document.getElementById('addName').value = "";
            document.getElementById('addInit').value = "";

            sortCombat();
            saveGM();
            renderCombat();
        }

        function genMobs() {
            const baseName = document.getElementById('mobName').value || "Mob";
            const count = parseInt(document.getElementById('mobCount').value) || 1;
            const mod = parseInt(document.getElementById('mobInitMod').value) || 0;
            const score = parseInt(document.getElementById('mobDexScore').value) || 10;
            const hp = parseInt(document.getElementById('mobHP').value) || 0;

            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * 20) + 1;
                const total = roll + mod;
                const name = count > 1 ? `${baseName} ${i + 1}` : baseName;

                gmData.combatants.push({
                    id: Date.now() + i,
                    name: name,
                    total: total,
                    tie: score,
                    hp: hp > 0 ? hp : null,
                    maxHp: hp > 0 ? hp : null
                });
            }

            sortCombat();
            saveGM();
            renderCombat();
            document.getElementById('mobBody').style.display = 'none';
        }

        function renderCombat() {
            const list = document.getElementById('combatList');
            document.getElementById('roundVal').innerText = gmData.round;

            list.innerHTML = gmData.combatants.map((c, i) => {
                const activeClass = (i === gmData.activeIdx) ? 'active' : '';
                let hpHtml = '';
                if (c.hp !== null) {
                    const bloodied = (c.hp <= c.maxHp / 2) ? 'color:#e74c3c;' : 'color:#2ecc71;';
                    hpHtml = `
                    <div class="hp-controls">
                        <button class="btn-dmg-qs" onclick="modHP(${i}, -1)">-1</button>
                        <button class="btn-dmg-qs" onclick="modHP(${i}, -5)">-5</button>
                        <div class="hp-display" style="${bloodied}" onclick="setHP(${i})">${c.hp}</div>
                    </div>
                `;
                }

                return `
            <div class="combat-item ${activeClass}">
                <div class="init-box">
                    <div class="init-val">${c.total}</div>
                    <div class="init-tie">.${c.tie}</div>
                </div>
                <div class="name-box">
                    <div class="name-main">${c.name}</div>
                    ${activeClass ? '<div class="name-meta" style="color:var(--accent);">Taking Turn...</div>' : ''}
                </div>
                <div style="display:flex; align-items:center;">
                    ${hpHtml}
                    <button class="btn-del" onclick="delCombatant(${i})">&times;</button>
                </div>
            </div>
            `;
            }).join('');
        }

        function nextTurn() {
            if (gmData.combatants.length === 0) return;
            gmData.activeIdx++;
            if (gmData.activeIdx >= gmData.combatants.length) {
                gmData.activeIdx = 0;
                gmData.round++;
            }
            saveGM();
            renderCombat();
            setTimeout(() => {
                const activeEl = document.querySelector('.combat-item.active');
                if (activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function prevTurn() {
            if (gmData.combatants.length === 0) return;
            gmData.activeIdx--;
            if (gmData.activeIdx < 0) {
                gmData.activeIdx = gmData.combatants.length - 1;
                gmData.round = Math.max(1, gmData.round - 1);
            }
            saveGM();
            renderCombat();
        }

        function clearCombat() {
            if (confirm("Clear Tracker?")) {
                gmData.combatants = [];
                gmData.round = 1;
                gmData.activeIdx = 0;
                saveGM();
                renderCombat();
            }
        }

        function delCombatant(i) {
            gmData.combatants.splice(i, 1);
            if (gmData.activeIdx >= gmData.combatants.length) gmData.activeIdx = 0;
            saveGM();
            renderCombat();
        }

        function modHP(i, delta) {
            if (gmData.combatants[i].hp !== null) {
                gmData.combatants[i].hp += delta;
                saveGM(); renderCombat();
            }
        }

        function setHP(i) {
            const val = prompt("Set HP:", gmData.combatants[i].hp);
            if (val !== null) {
                gmData.combatants[i].hp = parseInt(val);
                saveGM(); renderCombat();
            }
        }

        // --- REFERENCE & LOOT ---
        function renderConditions() {
            const div = document.getElementById('conditionsList');
            div.innerHTML = Object.keys(conditions).map(k => `
            <div>
                <button class="accordion-btn" onclick="this.nextElementSibling.classList.toggle('show')">${k}</button>
                <div class="accordion-body">
                    <span class="cond-tag">${k.toUpperCase()}</span> ${conditions[k]}
                </div>
            </div>
        `).join('');
        }

        function genLoot(type) {
            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            let result = "";

            if (type === 'pocket') {
                const category = pick(lootTables.pocket);
                const adj = pick(category.adjs);
                const noun = pick(category.nouns);
                result = `${adj} ${noun} (Worthless)`;
            }
            else if (type === 'trinket') {
                const noun = pick(lootTables.trinket.nouns);
                const suffix = Math.random() > 0.5 ? " " + pick(lootTables.trinket.suffixes) : "";
                const isFancy = Math.random() < 0.4;
                const tier = isFancy ? lootTables.trinket.fancy : lootTables.trinket.cheap;
                const material = pick(tier.materials);
                const value = pick(tier.values);
                result = `${material} ${noun}${suffix} (${value})`;
            }

            const el = document.getElementById('lootResult');
            el.style.opacity = 0;
            setTimeout(() => {
                el.innerText = result;
                el.style.opacity = 1;
            }, 100);
        }

        function switchTab(id) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        init();

        // --- EXCITED BACKGROUND FIELD SCRIPT ---
        (function () {
            const canvas = document.getElementById('vector-cloud');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let width, height;

            const mouse = { x: -999, y: -999, active: false, down: false };
            let lastScrollY = window.scrollY;
            let scrollVelocity = 0;

            const SPACING = 30;
            const FIELD_RADIUS = 200;
            let accentColor = '#4ecdc4';

            const updateAccent = () => {
                const style = getComputedStyle(document.documentElement);
                accentColor = style.getPropertyValue('--accent').trim();
            };

            const resize = () => {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
                updateAccent();
            };

            window.addEventListener('resize', resize);
            window.addEventListener('mousemove', e => {
                mouse.x = e.clientX;
                mouse.y = e.clientY;
                mouse.active = true;
            });
            window.addEventListener('mousedown', () => mouse.down = true);
            window.addEventListener('mouseup', () => mouse.down = false);
            window.addEventListener('touchstart', e => {
                mouse.x = e.touches[0].clientX;
                mouse.y = e.touches[0].clientY;
                mouse.active = true;
                mouse.down = true;
            });
            window.addEventListener('touchmove', e => {
                mouse.x = e.touches[0].clientX;
                mouse.y = e.touches[0].clientY;
            });
            window.addEventListener('touchend', () => { mouse.active = false; mouse.down = false; });

            window.addEventListener('scroll', () => {
                const currentY = window.scrollY;
                const delta = currentY - lastScrollY;
                scrollVelocity = delta;
                lastScrollY = currentY;
            });

            resize();

            const animate = () => {
                ctx.clearRect(0, 0, width, height);
                scrollVelocity *= 0.9;

                if (!mouse.active && Math.abs(scrollVelocity) < 0.1) {
                    requestAnimationFrame(animate);
                    return;
                }

                const startX = Math.floor((mouse.x - FIELD_RADIUS) / SPACING) * SPACING;
                const endX = Math.floor((mouse.x + FIELD_RADIUS) / SPACING) * SPACING;
                const startY = Math.floor((mouse.y - FIELD_RADIUS) / SPACING) * SPACING;
                const endY = Math.floor((mouse.y + FIELD_RADIUS) / SPACING) * SPACING;

                const time = Date.now();

                for (let gx = startX; gx <= endX; gx += SPACING) {
                    for (let gy = startY; gy <= endY; gy += SPACING) {
                        const dx = gx - mouse.x;
                        const dy = gy - mouse.y;
                        const distSq = dx * dx + dy * dy;

                        if (distSq > FIELD_RADIUS * FIELD_RADIUS) continue;

                        const dist = Math.sqrt(distSq);

                        let alpha = 0;
                        if (dist < 40) {
                            alpha = (dist / 40);
                        } else {
                            alpha = 1 - ((dist - 40) / (FIELD_RADIUS - 40));
                        }
                        alpha = Math.max(0, Math.min(1, alpha));

                        if (alpha <= 0.01) continue;

                        let angle = Math.atan2(dy, dx);

                        if (mouse.down) angle += Math.sin(time * 0.05 + gx + gy) * 0.5;

                        const windForce = -scrollVelocity * 0.05;
                        if (Math.abs(windForce) > 0.01) {
                            const vx = Math.cos(angle);
                            const vy = Math.sin(angle);
                            const nvx = vx;
                            const nvy = vy + windForce;
                            angle = Math.atan2(nvy, nvx);
                        }

                        const length = 14 * alpha;
                        const tipX = gx + Math.cos(angle) * length;
                        const tipY = gy + Math.sin(angle) * length;

                        const thickness = length * 0.2;
                        const perpX = -Math.sin(angle) * thickness;
                        const perpY = Math.cos(angle) * thickness;

                        ctx.fillStyle = accentColor;
                        ctx.globalAlpha = alpha * 0.8;

                        ctx.beginPath();
                        ctx.moveTo(gx + perpX, gy + perpY);
                        ctx.lineTo(gx - perpX, gy - perpY);
                        ctx.lineTo(tipX, tipY);
                        ctx.fill();
                    }
                }

                requestAnimationFrame(animate);
            };

            animate();
        })();
    </script>
</body>

</html>