<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Bracket v4.3 (Fixed Layout)</title>
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --node-bg: #252525;
            --node-hover: #303030;
            --accent: #00bcd4;
            --gold: #ffc107;
            --text: #eee;
            --line: #444;
            --node-h: 46px;
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- UI CHROME --- */
        #toolbar {
            height: 48px; background: var(--panel); border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            z-index: 100;
        }
        .btn { 
            background: transparent; border: 1px solid #444; color: #aaa; 
            padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; 
        }
        .btn:hover { border-color: var(--accent); color: var(--accent); }
        .btn-p { background: var(--accent); color: #000; border: none; font-weight: bold; }

        /* --- MAIN STAGE --- */
        #stage {
            flex: 1; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }

        #bracket-root {
            display: flex; flex-direction: column; gap: 40px; align-items: center;
            padding: 40px; transition: transform 0.2s;
        }

        /* --- LAYOUT CONTAINERS --- */
        .wb-container, .lb-container {
            display: flex; gap: 40px; align-items: center; justify-content: center;
        }
        .lb-container {
            border-top: 1px dashed #333; padding-top: 30px; 
        }

        /* The Columns */
        .side-block { display: flex; gap: 40px; }
        .round-col { display: flex; flex-direction: column; justify-content: space-around; min-width: 160px; }

        /* --- NODES --- */
        .node {
            height: var(--node-h); background: var(--node-bg); border: 1px solid #333;
            border-radius: 4px; display: flex; flex-direction: column; justify-content: center;
            position: relative; cursor: pointer; transition: 0.2s; z-index: 2;
        }
        .node:hover { transform: scale(1.05); border-color: var(--accent); z-index: 10; }
        
        .node-id { position: absolute; top: -8px; right: 0; font-size: 0.5rem; color: #555; background: var(--node-bg); padding: 0 4px; }
        .p-row { display: flex; justify-content: space-between; padding: 0 8px; font-size: 0.75rem; }
        .p-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 110px; color: #bbb; }
        .p-sc { font-weight: bold; color: #555; }
        
        .win .p-name { color: var(--accent); font-weight: bold; }
        .win .p-sc { color: var(--accent); }
        .lose .p-name { text-decoration: line-through; opacity: 0.4; }

        /* CENTER NODES */
        .center-stack { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 200px; }
        .gf-node { border: 1px solid var(--gold); box-shadow: 0 0 10px rgba(255,193,7,0.1); height: 60px; width: 100%; }
        .wf-node { border: 1px solid var(--accent); height: 50px; width: 100%; }
        .lf-node { border: 1px solid #666; width: 100%; }

        /* --- CONNECTORS --- */
        /* Left Side: Line sticks out to the RIGHT */
        .side-block.left .node::after {
            content: ''; position: absolute; right: -41px; top: 50%; width: 40px; height: 1px; background: var(--line); z-index: -1;
        }
        /* Right Side: Line sticks out to the LEFT */
        .side-block.right .node::after {
            content: ''; position: absolute; left: -41px; top: 50%; width: 40px; height: 1px; background: var(--line); z-index: -1;
        }

        /* --- MODALS --- */
        #setup-modal, #score-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .active { display: flex !important; }
        .modal-box { background: var(--panel); border: 1px solid #444; padding: 25px; border-radius: 8px; width: 320px; }
        textarea { width: 100%; height: 100px; background: #000; border: 1px solid #333; color: #fff; box-sizing: border-box; }
        
        .score-row { display: flex; justify-content: space-between; align-items: center; background: #111; margin-bottom: 10px; padding: 10px; border-radius: 4px; }
        .sc-inp { width: 40px; text-align: center; background: transparent; border: none; color: #fff; font-size: 1.2rem; }
        .btn-adj { background: #333; color: #fff; border: none; width: 30px; height: 30px; cursor: pointer; }

    </style>
</head>
<body>

<div id="setup-modal" class="active">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--accent)">16-Player Setup</h3>
        <textarea id="pInput" placeholder="Enter names..."></textarea>
        <button class="btn-p" style="width:100%; margin-top:10px;" onclick="generate()">Start Tournament</button>
    </div>
</div>

<div id="toolbar">
    <span style="font-weight:bold; color:var(--accent)">UNIFIED v4.3</span>
    <div>
        <button class="btn" onclick="autoFit()">Fit</button>
        <button class="btn" onclick="reset()">Reset</button>
    </div>
</div>

<div id="stage">
    <div id="bracket-root">
        
        <div class="wb-container">
            <div class="side-block left" id="wb-left"></div>

            <div class="center-stack">
                <div style="font-size:0.6rem; color:var(--gold); letter-spacing:2px; margin-bottom:4px;">GRAND FINALS</div>
                <div id="gf-slot" style="width:100%"></div>
                
                <div style="height:20px; width:1px; background:var(--line);"></div>
                
                <div style="font-size:0.6rem; color:var(--accent); letter-spacing:1px; margin-bottom:4px;">WINNERS FINAL</div>
                <div id="wf-slot" style="width:100%"></div>
                
                <div style="height:40px; width:1px; background:var(--line); opacity:0.3"></div>
            </div>

            <div class="side-block right" id="wb-right"></div>
        </div>

        <div class="lb-container">
            <div class="side-block left" id="lb-left"></div>
            
            <div class="center-stack">
                <div style="font-size:0.6rem; color:#777; letter-spacing:1px;">L-FINALS</div>
                <div id="lf-slot" style="width:100%"></div>
            </div>
            
            <div class="side-block right" id="lb-right"></div>
        </div>

    </div>
</div>

<div id="score-modal">
    <div class="modal-box">
        <div class="score-row">
            <span id="mP1">P1</span>
            <div>
                <button class="btn-adj" onclick="mod(-1, 1)">-</button>
                <input id="sP1" class="sc-inp" readonly value="0">
                <button class="btn-adj" onclick="mod(1, 1)">+</button>
            </div>
        </div>
        <div class="score-row">
            <span id="mP2">P2</span>
            <div>
                <button class="btn-adj" onclick="mod(-1, 2)">-</button>
                <input id="sP2" class="sc-inp" readonly value="0">
                <button class="btn-adj" onclick="mod(1, 2)">+</button>
            </div>
        </div>
        <button class="btn-p" style="width:100%" onclick="saveScore()">Save</button>
        <button class="btn" style="width:100%; margin-top:5px; border:none;" onclick="closeScore()">Cancel</button>
    </div>
</div>

<script>
    let data = { matches: [], active: false };
    let curId = null;

    function generate() {
        const txt = document.getElementById('pInput').value.trim();
        let names = txt.split('\n').map(x=>x.trim()).filter(x=>x);
        if(names.length < 4) return alert("Need 4+ players");
        
        names.sort(() => Math.random() - 0.5);
        const seeds = [];
        for(let i=0; i<16; i++) seeds.push(names[i] || "BYE");

        const m = [];
        
        // --- WINNERS STRUCTURE ---
        // R1 (8 matches)
        let w1 = [];
        for(let i=0; i<8; i++) {
            const id = `w1_${i}`;
            const side = i<4 ? 'left' : 'right';
            m.push({ id, type:'wb', r:1, side, p1:seeds[i*2], p2:seeds[i*2+1], s1:0, s2:0, win:null });
            w1.push(id);
        }
        // R2 (4 matches)
        let w2 = [];
        for(let i=0; i<4; i++) {
            const id = `w2_${i}`;
            const side = i<2 ? 'left' : 'right';
            m.push({ id, type:'wb', r:2, side, p1:null, p2:null, s1:0, s2:0, win:null });
            w2.push(id);
            link(m, w1[i*2], id, 1); link(m, w1[i*2+1], id, 2);
        }
        // R3 (2 matches - Semis)
        let w3 = [];
        for(let i=0; i<2; i++) {
            const id = `w3_${i}`;
            const side = i===0 ? 'left' : 'right';
            m.push({ id, type:'wb', r:3, side, p1:null, p2:null, s1:0, s2:0, win:null });
            w3.push(id);
            link(m, w2[i*2], id, 1); link(m, w2[i*2+1], id, 2);
        }
        // R4 (Winners Final)
        const wfId = 'wf';
        m.push({ id: wfId, type:'wb', r:4, side:'center', p1:null, p2:null, s1:0, s2:0, win:null });
        link(m, w3[0], wfId, 1); link(m, w3[1], wfId, 2);

        // --- LOSERS STRUCTURE ---
        // L1 (4 matches) - Losers from W1
        let l1 = [];
        for(let i=0; i<4; i++) {
            const id = `l1_${i}`;
            const side = i<2 ? 'left' : 'right';
            m.push({ id, type:'lb', r:1, side, p1:null, p2:null, s1:0, s2:0, win:null });
            l1.push(id);
            linkLose(m, w1[i*2], id, 1); linkLose(m, w1[i*2+1], id, 2);
        }
        // L2 (4 matches) - Winners L1 vs Losers W2
        let l2 = [];
        for(let i=0; i<4; i++) {
            const id = `l2_${i}`;
            const side = i<2 ? 'left' : 'right';
            m.push({ id, type:'lb', r:2, side, p1:null, p2:null, s1:0, s2:0, win:null });
            l2.push(id);
            link(m, l1[i], id, 1); linkLose(m, w2[i], id, 2);
        }
        // L3 (2 matches) - Winners L2
        let l3 = [];
        for(let i=0; i<2; i++) {
            const id = `l3_${i}`;
            const side = i===0 ? 'left' : 'right';
            m.push({ id, type:'lb', r:3, side, p1:null, p2:null, s1:0, s2:0, win:null });
            l3.push(id);
            link(m, l2[i*2], id, 1); link(m, l2[i*2+1], id, 2);
        }
        // L4 (2 matches) - Winners L3 vs Losers W3
        let l4 = [];
        for(let i=0; i<2; i++) {
            const id = `l4_${i}`;
            const side = i===0 ? 'left' : 'right';
            m.push({ id, type:'lb', r:4, side, p1:null, p2:null, s1:0, s2:0, win:null });
            l4.push(id);
            link(m, l3[i], id, 1); linkLose(m, w3[i], id, 2);
        }
        // L5 (1 match) - LB Semis (Merge Left/Right)
        const l5Id = 'l5';
        m.push({ id: l5Id, type:'lb', r:5, side:'center', p1:null, p2:null, s1:0, s2:0, win:null });
        link(m, l4[0], l5Id, 1); link(m, l4[1], l5Id, 2);

        // L6 (1 match) - LB Finals (Winner L5 vs Loser WF)
        const lfId = 'lf';
        m.push({ id: lfId, type:'lb', r:6, side:'center', p1:null, p2:null, s1:0, s2:0, win:null });
        link(m, l5Id, lfId, 1); linkLose(m, wfId, lfId, 2);

        // --- GRAND FINALS ---
        const gfId = 'gf';
        m.push({ id: gfId, type:'gf', r:99, side:'center', p1:null, p2:null, s1:0, s2:0, win:null });
        link(m, wfId, gfId, 1); link(m, lfId, gfId, 2);

        data.matches = m;
        data.active = true;
        save();
        render();
        advanceByes();
        document.getElementById('setup-modal').classList.remove('active');
        setTimeout(autoFit, 100);
    }

    // --- LINKERS ---
    function link(arr, src, dest, slot) { 
        let x=arr.find(z=>z.id===src); if(x){ x.nextWin=dest; x.winSlot=slot; } 
    }
    function linkLose(arr, src, dest, slot) { 
        let x=arr.find(z=>z.id===src); if(x){ x.nextLose=dest; x.loseSlot=slot; } 
    }

    // --- RENDERER ---
    function render() {
        if(!data.active) return;

        // Clear
        const els = ['wb-left','wb-right','lb-left','lb-right','gf-slot','wf-slot','lf-slot'];
        els.forEach(id => document.getElementById(id).innerHTML = '');

        // WB Left: R1 -> R2 -> R3
        const wl = document.getElementById('wb-left');
        wl.appendChild(col('wb',1,'left'));
        wl.appendChild(col('wb',2,'left'));
        wl.appendChild(col('wb',3,'left'));

        // WB Right: R3 <- R2 <- R1 (Fixed Order)
        const wr = document.getElementById('wb-right');
        wr.appendChild(col('wb',3,'right'));
        wr.appendChild(col('wb',2,'right'));
        wr.appendChild(col('wb',1,'right'));

        // LB Left: R1 -> R2 -> R3 -> R4
        const ll = document.getElementById('lb-left');
        ll.appendChild(col('lb',1,'left'));
        ll.appendChild(col('lb',2,'left'));
        ll.appendChild(col('lb',3,'left'));
        ll.appendChild(col('lb',4,'left'));

        // LB Right: R4 <- R3 <- R2 <- R1
        const lr = document.getElementById('lb-right');
        lr.appendChild(col('lb',4,'right'));
        lr.appendChild(col('lb',3,'right'));
        lr.appendChild(col('lb',2,'right'));
        lr.appendChild(col('lb',1,'right'));

        // Center
        drawCenter('gf', 'gf-slot', 'gf-node');
        drawCenter('wb', 'wf-slot', 'wf-node', 4);
        drawCenter('lb', 'lf-slot', 'lf-node', 6);
    }

    function col(type, r, side) {
        const d = document.createElement('div');
        d.className = 'round-col';
        let h = 300; // Base height for alignment
        if(type==='lb') h = 280;
        d.style.height = h+'px';
        
        const matches = data.matches.filter(m => m.type===type && m.r===r && m.side===side);
        matches.forEach(m => d.appendChild(node(m)));
        return d;
    }

    function drawCenter(type, slotId, cls, r) {
        let m;
        if(type==='gf') m = data.matches.find(x=>x.type==='gf');
        else m = data.matches.find(x=>x.type===type && x.r===r && x.side==='center');
        if(m) document.getElementById(slotId).appendChild(node(m, cls));
    }

    function node(m, extra='') {
        const el = document.createElement('div');
        el.className = 'node ' + extra;
        el.onclick = () => openScore(m.id);
        
        const p1c = m.win===1?'win':(m.win===2?'lose':'');
        const p2c = m.win===2?'win':(m.win===1?'lose':'');

        el.innerHTML = `
            <div class="node-id">${m.id.split('_').join('.')}</div>
            <div class="p-row ${p1c}">
                <div class="p-name">${m.p1||'-'}</div><div class="p-sc">${m.s1}</div>
            </div>
            <div class="p-row ${p2c}">
                <div class="p-name">${m.p2||'-'}</div><div class="p-sc">${m.s2}</div>
            </div>
        `;
        return el;
    }

    // --- SCORE ---
    function openScore(id) {
        curId = id;
        const m = data.matches.find(x=>x.id===id);
        if(!m.p1 || !m.p2) return;
        document.getElementById('mP1').innerText = m.p1;
        document.getElementById('mP2').innerText = m.p2;
        document.getElementById('sP1').value = m.s1;
        document.getElementById('sP2').value = m.s2;
        document.getElementById('score-modal').classList.add('active');
    }
    function closeScore() { document.getElementById('score-modal').classList.remove('active'); curId = null; }
    function mod(d, p) {
        const el = document.getElementById(p===1?'sP1':'sP2');
        el.value = Math.max(0, parseInt(el.value)+d);
    }
    function saveScore() {
        const m = data.matches.find(x=>x.id===curId);
        const s1 = parseInt(document.getElementById('sP1').value);
        const s2 = parseInt(document.getElementById('sP2').value);
        if(s1===s2) return alert("No draws");
        
        m.s1=s1; m.s2=s2; m.win = s1>s2?1:2;
        
        const w = m.win===1?m.p1:m.p2;
        const l = m.win===1?m.p2:m.p1;

        if(m.nextWin) update(m.nextWin, m.winSlot, w);
        if(m.nextLose) update(m.nextLose, m.loseSlot, l);

        save(); render(); advanceByes(); closeScore();
    }
    function update(id, slot, name) {
        const x = data.matches.find(z=>z.id===id);
        if(x) {
            if(slot===1) x.p1=name; else x.p2=name;
            x.win=null; x.s1=0; x.s2=0;
        }
    }

    // --- UTILS ---
    function advanceByes() {
        let dirty = false;
        data.matches.forEach(m => {
            if(!m.win && (m.p1==='BYE' || m.p2==='BYE')) {
                m.s1 = m.p2==='BYE'?1:0; m.s2 = m.p1==='BYE'?1:0;
                m.win = m.p2==='BYE'?1:2;
                const w = m.win===1?m.p1:m.p2;
                if(m.nextWin) update(m.nextWin, m.winSlot, w);
                // BYE losers don't drop to LB usually, or drop as BYE
                if(m.nextLose) update(m.nextLose, m.loseSlot, 'BYE'); 
                dirty = true;
            }
        });
        if(dirty) { save(); render(); }
    }
    function autoFit() {
        const r = document.getElementById('bracket-root');
        r.style.transform = 'scale(1)';
        const sc = Math.min(document.body.clientWidth / (r.scrollWidth+40), document.body.clientHeight / (r.scrollHeight+40), 1);
        r.style.transform = `scale(${sc})`;
    }
    function save() { localStorage.setItem('uni_v43', JSON.stringify(data)); }
    function reset() { if(confirm("Reset?")) { localStorage.removeItem('uni_v43'); location.reload(); } }

    const s = localStorage.getItem('uni_v43');
    if(s) { data=JSON.parse(s); if(data.active){ document.getElementById('setup-modal').classList.remove('active'); render(); setTimeout(autoFit,100); }}

    window.addEventListener('resize', ()=>setTimeout(autoFit, 200));
</script>
</body>
</html>
